name: CMake

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

env:
  BUILD_TYPE: Release

jobs:
  build-windows:
    runs-on: windows-latest

    steps:
      # Install gf via vcpkg
      - uses: actions/checkout@v2
        with:
          repository: Microsoft/vcpkg
          path: vcpkg

      - name: vcpkg cache
        id: cache-vcpkg
        uses: actions/cache@v2.1.6
        with:
          path: vcpkg
          key: ${{ runner.os }}-vcpkg

      - name: Build gf
        if: steps.cache-vcpkg.outputs.cache-hit != 'true'
        working-directory: ${{github.workspace}}/vcpkg
        run: |
          .\bootstrap-vcpkg.bat
          .\vcpkg.exe install gamedev-framework:x64-windows

      # Install Ninja from https://cristianadam.eu/20191222/using-github-actions-with-c-plus-plus-and-cmake/
      - name: Download Ninja and CMake
        id: cmake_and_ninja
        working-directory: ${{github.workspace}}/ninja
        shell: cmake -P {0}
        run: |
          set(ninja_version "1.10.2")

          message(STATUS "Using host CMake version: ${CMAKE_VERSION}")

          if ("${ { runner.os } }" STREQUAL "Windows")
            set(ninja_suffix "win.zip")
          elseif ("${ { runner.os } }" STREQUAL "Linux")
            set(ninja_suffix "linux.zip")
          elseif ("${ { runner.os } }" STREQUAL "macOS")
            set(ninja_suffix "mac.zip")
          endif()

          set(ninja_url "https://github.com/ninja-build/ninja/releases/download/v${ninja_version}/ninja-${ninja_suffix}")
          file(DOWNLOAD "${ninja_url}" ./ninja.zip SHOW_PROGRESS)
          execute_process(COMMAND ${CMAKE_COMMAND} -E tar xvf ./ninja.zip)

          if (NOT "${ { runner.os } }" STREQUAL "Windows")
            execute_process(
              COMMAND chmod +x ninja
            )
          endif()

        # Prises build
        - uses: actions/checkout@v2
          with:
            path: prises

        - name: Configure Prises
          run: cmake -S ${{github.workspace}}/prises/ -B ${{github.workspace}}/prises/build -G Ninja -DCMAKE_MAKE_PROGRAM=${{github.workspace}}/ninja/ninja.exe -DCMAKE_BUILD_TYPE=${{env.BUILD_TYPE}} -DCMAKE_TOOLCHAIN_FILE=${{github.workspace}}/vcpkg/scripts/buildsystems/vcpkg.cmake

        - name: Build Prises
          run: cmake --build ${{github.workspace}}/prises/build --config ${{env.BUILD_TYPE}} --parallel

        - name: Create snapshot
          working-directory: ${{github.workspace}}/prises/build
          run: cpack -C CPackConfig.cmake

        - uses: actions/upload-artifact@v2
          with:
            name: prises-snapshot
            path: ${{github.workspace}}/prises/build/*.zip
            if-no-files-found: error

  build-linux:
    runs-on: ubuntu-latest

    steps:
    # Dependencies
    - name: Install dependency
      run: |
        sudo apt update
        sudo apt install -y libsdl2-dev libboost-dev libfreetype6-dev zlib1g-dev libpugixml-dev

    # gf build
    - uses: actions/checkout@v2
      with:
        repository: GamedevFramework/gf
        submodules: recursive
        path: gf

    - name: Configure gf
      run: cmake -DGF_BUILD_GAMES=OFF -DGF_BUILD_EXAMPLES=OFF -DGF_BUILD_DOCUMENTATION=OFF -DGF_SINGLE_COMPILTATION_UNIT=OFF -DGF_DEBUG=OFF -DCMAKE_BUILD_TYPE=${{env.BUILD_TYPE}} -DCMAKE_INSTALL_PREFIX=${{github.workspace}}/gf/build/install -S \${{github.workspace}}/gf/ -B ${{github.workspace}}/gf/build

    - name: Build gf
      run: cmake --build ${{github.workspace}}/gf/build --config ${{env.BUILD_TYPE}} --parallel

    - name: Install gf
      run: cmake --install ${{github.workspace}}/gf/build --config ${{env.BUILD_TYPE}} --strip

    # Prises build
    - uses: actions/checkout@v2
      with:
        path: prises

    - name: Configure Prises
      run: cmake -S ${{github.workspace}}/prises/ -B ${{github.workspace}}/prises/build -DCMAKE_BUILD_TYPE=${{env.BUILD_TYPE}} -DCMAKE_PREFIX_PATH=${{github.workspace}}/gf/build/install

    - name: Build Prises
      run: cmake --build ${{github.workspace}}/prises/build --config ${{env.BUILD_TYPE}} --parallel
